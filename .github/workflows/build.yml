name: Build Project

on:
  workflow_dispatch:
  push:
    branches:
      - linux-actions

env:
  FLATPAK_ID: io.github.hedge_dev.unleashedrecomp
  FREEDESKTOP_VERSION: 23.08
  LLVM_VERSION: 18

jobs:
  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ORG_TOKEN }}

      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.ASSET_REPO }}
          token: ${{ secrets.ASSET_REPO_TOKEN }}
          path: flatpak/private

      - name: Install dependencies
        run: |-
          sudo apt update
          sudo apt install -y flatpak-builder

      - name: Prepare Flatpak
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Sdk//${{ env.FREEDESKTOP_VERSION }}
          sudo flatpak install -y flathub org.freedesktop.Sdk.Extension.llvm${{ env.LLVM_VERSION }}//${{ env.FREEDESKTOP_VERSION }}

      - name: Build Flatpak
        run: |
          sudo flatpak-builder --force-clean --install-deps-from=flathub --repo=repo --install builddir --ccache ./flatpak/${{ env.FLATPAK_ID }}.json
          sudo flatpak build-bundle repo ./${{ env.FLATPAK_ID }}.flatpak ${{ env.FLATPAK_ID }} --runtime-repo=https://flathub.org/repo/flathub.flatpakrepo

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: UnleashedRecomp-flatpak
          path: ./${{ env.FLATPAK_ID }}.flatpak